# Pi Zero 2W Digital Synthesizer

A real-time polyphonic digital synthesizer built with Raspberry Pi Zero 2W, featuring MIDI keyboard support, analog potentiometer control, and professional audio output.



## Features

- **Real-time polyphonic synthesis** (up to 16 voices)
- **MIDI keyboard support** (tested with AKAI MPK mini 3)
- **4 analog potentiometer controls**
- **Professional audio output** via PCM5102 DAC
- **Multiple waveforms** (Sine, Square, Sawtooth, Triangle)
- **ADSR envelope control**
- **Low-pass filtering**
- **Real-time parameter adjustment**

## Hardware Components

### Core Components
- **Raspberry Pi Zero 2W** - Main processing unit
- **PCM5102 DAC** - 24-bit audio digital-to-analog converter
- **ADS1115** - 16-bit 4-channel analog-to-digital converter
- **4x Potentiometers**  - Analog controls
- **AKAI MPK mini 3** - MIDI keyboard controller (or any USB MIDI device)

### Supporting Components
- MicroSD card
- USB-C power supply (5V/3A recommended for USB host mode)
- Breadboard and jumper wires
- Audio output (speakers/headphones)

## Wiring Diagram

### ADS1115 (Potentiometer ADC)
```
ADS1115 → Pi Zero 2W
VCC     → 3.3V (Pin 1)
GND     → Ground (Pin 6)
SDA     → GPIO 2/SDA (Pin 3)
SCL     → GPIO 3/SCL (Pin 5)
ADDR    → Ground (sets I2C address to 0x48)
```

### PCM5102 DAC (Audio Output)
```
PCM5102 → Pi Zero 2W
VCC     → 5V (Pin 2)
GND     → Ground (Pin 6)
BCK     → GPIO 18 (Pin 12) - Bit Clock
LCK     → GPIO 19 (Pin 35) - Word Clock  
DIN     → GPIO 21 (Pin 40) - Data
SCK     → Ground (tie to ground)
```

### Potentiometers (4x)
```
Each Potentiometer:
Left pin   → Ground
Right pin  → 3.3V
Center pin → ADS1115 inputs (A0, A1, A2, A3)

Pot 1 (A0) → Frequency/Volume control
Pot 2 (A1) → Waveform selection
Pot 3 (A2) → Filter cutoff
Pot 4 (A3) → Envelope control
```

### MIDI Keyboard
- Connect via USB to Pi Zero 2W (requires USB host mode)

## Software Setup

### 1. Raspberry Pi OS Configuration

```bash
# Enable I2S audio for PCM5102
sudo nano /boot/config.txt
# Add these lines:
dtparam=i2s=on
dtoverlay=hifiberry-dac

# Enable I2C for ADS1115
sudo raspi-config
# Interface Options → I2C → Yes

# Enable USB host mode (for MIDI keyboard)
sudo nano /boot/config.txt
# Change: dtoverlay=dwc2,dr_mode=host

sudo reboot
```

### 2. Install Dependencies

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install Python packages
sudo apt install -y python3-pip python3-numpy python3-scipy
sudo pip3 install adafruit-circuitpython-ads1x15 sounddevice python-rtmidi

# Verify I2C devices
sudo i2cdetect -y 1  # Should show 0x48 for ADS1115
```

### 3. Test Audio Output

```bash
# Test PCM5102 DAC
python3 -c "
import numpy as np
import sounddevice as sd
sample_rate = 44100
duration = 2
frequency = 440
t = np.linspace(0, duration, int(sample_rate * duration), False)
audio = np.sin(2 * np.pi * frequency * t)
audio_int16 = (audio * 0.3 * 32767).astype(np.int16)
sd.play(audio_int16, sample_rate)
"
```

## Project Files

### Core Synthesizer Files

#### `synth.py`
**Original potentiometer-only synthesizer**
- 4-pot control (Frequency, Volume, Waveform, Filter)
- Single-voice synthesis
- Real-time audio callback architecture
- Calibrated potentiometer ranges

#### `midi_poly_synth.py`
**MIDI + Potentiometer polyphonic synthesizer**
- 12-voice polyphony
- MIDI keyboard input + 4 analog pots
- Advanced ADSR envelope control
- Real-time mixing engine

#### `mpk_only_synth.py` (RECOMMENDED)
**MPK mini 3 exclusive synthesizer**
- 16-voice polyphony
- Uses only MPK mini 3 (8 knobs + keys + pads)
- No external potentiometers needed
- Complete MIDI control mapping

### Utility Files

#### `midi_test.py`
**MIDI device tester**
- Scans for available MIDI devices
- Real-time MIDI message monitoring
- Note name and frequency display
- Useful for debugging MIDI connections

#### `pot_calibration.py`
**Potentiometer calibration tool**
- Measures actual min/max values of pots
- Generates calibration data
- Creates code snippets for synth integration

#### `pot_calibration.json`
**Calibration data file**
- Contains measured potentiometer ranges
- Used by synthesizers for proper scaling
- Generated by calibration tool

## Control Mapping

### MPK mini 3 Controls (mpk_only_synth.py)
| Control | Parameter | Range |
|---------|-----------|-------|
| **Keys** | Note pitch | Full chromatic range |
| **Pads** | Percussion/Notes | Velocity sensitive |
| **Knob 1** | Master Volume | 0-100% |
| **Knob 2** | Waveform | Sine→Square→Saw→Triangle |
| **Knob 3** | Filter Cutoff | 200Hz-8000Hz |
| **Knob 4** | Attack Time | 1ms-2s |
| **Knob 5** | Decay Time | 10ms-2s |
| **Knob 6** | Sustain Level | 0-100% |
| **Knob 7** | Release Time | 10ms-4s |
| **Knob 8** | Detune/Pitch Bend | ±100 cents |

### Potentiometer Controls (other versions)
| Pot | Parameter | Range |
|-----|-----------|-------|
| **Pot 1 (A0)** | Frequency/Volume | 100Hz-2000Hz / 0-100% |
| **Pot 2 (A1)** | Waveform | Sine/Square/Sawtooth/Triangle |
| **Pot 3 (A2)** | Filter Cutoff | 200Hz-8000Hz |
| **Pot 4 (A3)** | Envelope/Filter | Variable timing |

## Audio Architecture

### Signal Path
```
MIDI Input → Voice Management → Waveform Generation → ADSR Envelope → 
Low-Pass Filter → Polyphonic Mixing → Master Volume → PCM5102 DAC → Audio Output
```

### Technical Specifications
- **Sample Rate**: 44.1kHz
- **Bit Depth**: 32-bit float (internal), 24-bit output
- **Latency**: ~12ms (512 sample buffer)
- **Polyphony**: 16 voices maximum
- **Audio Quality**: Professional (PCM5102 DAC)

## Software Architecture

### Key Technologies
- **SoundDevice**: Professional audio callback architecture
- **NumPy**: Optimized audio processing and waveform generation
- **RTMidi**: Real-time MIDI input handling
- **CircuitPython**: Hardware interfacing (ADS1115)
- **Threading**: Separate threads for audio, MIDI, and control input

### Design Strategies

#### Real-Time Audio
- **Callback-based architecture** prevents audio dropouts
- **Separate threads** for control reading vs audio generation
- **Optimized NumPy operations** for efficient processing
- **High-latency mode** for Raspberry Pi stability

#### Voice Management
- **Dynamic voice allocation** with oldest-voice removal
- **Per-voice ADSR envelopes** for realistic note behavior
- **Phase continuity** prevents audio clicks/pops
- **Efficient mixing** of multiple voices

#### MIDI Integration
- **Auto-detection** of MIDI devices
- **Real-time message parsing** for notes and control changes
- **Velocity sensitivity** for expressive playing
- **Control Change mapping** for real-time parameter adjustment

## Quick Start

### Option 1: MPK mini 3 Only (Recommended)
```bash
# No hardware assembly required!
python3 mpk_only_synth.py
```

### Option 2: Full Hardware Build
```bash
# 1. Wire components according to diagrams above
# 2. Calibrate potentiometers
python3 pot_calibration.py

# 3. Run full synthesizer
python3 midi_poly_synth.py
```

### Option 3: Development/Testing
```bash
# Test MIDI connection
python3 midi_test.py

# Test potentiometer-only version
python3 synth.py
```

## Troubleshooting

### Audio Issues
- **No sound**: Check PCM5102 wiring and I2S configuration
- **Crackling audio**: Increase buffer size or use higher latency
- **ALSA underruns**: Optimize callback code, increase blocksize

### MIDI Issues
- **Device not found**: Verify USB host mode configuration
- **Connection drops**: Check power supply (use 3A adapter)
- **No response**: Test with `midi_test.py` first

### Potentiometer Issues
- **Limited range**: Run `pot_calibration.py` to measure actual ranges
- **Erratic behavior**: Check wiring and power connections
- **No response**: Verify I2C connection and ADS1115 address

## Performance Notes

### Raspberry Pi Zero 2W Optimization
- **512-sample buffers** prevent underruns
- **High-latency audio mode** for stability
- **Efficient filtering** only when needed
- **Limited polyphony** (16 voices max) for reliable performance

### Power Considerations
- **USB host mode** requires 3A power supply
- **MPK mini 3** draws significant current
- **Powered USB hub** recommended for multiple devices

## Future Enhancements

- [ ] **Oscilloscope integration** for waveform visualization
- [ ] **Effects processing** (reverb, delay, chorus)
- [ ] **Preset system** for saving/loading sounds
- [ ] **Sequencer integration** for pattern-based composition
- [ ] **Multi-timbral support** for multiple instruments
- [ ] **Web interface** for remote control

## License

This project is open source. Feel free to modify, distribute, and use for educational or commercial purposes.

## Acknowledgments

- **Adafruit** for CircuitPython libraries
- **Raspberry Pi Foundation** for hardware
- **AKAI** for the MPK mini 3 MIDI controller
- **Python audio community** for SoundDevice and NumPy

---
